
const char font[128][8] = { 
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x04,0x0e,0x0f,0x0e,0x04,0x00,0x00},
    {0x00,0x04,0x0a,0x04,0x0a,0x04,0x0a,0x04},
    {0x0a,0x0a,0x0e,0x0a,0x0a,0x0c,0x08,0x08},
    {0x07,0x01,0x03,0x0d,0x05,0x0c,0x04,0x04},
    {0x06,0x01,0x06,0x00,0x0c,0x04,0x0c,0x04},
    {0x01,0x01,0x01,0x07,0x0c,0x04,0x0c,0x04},
    {0x00,0x0e,0x0a,0x0a,0x0e,0x00,0x00,0x00},
    {0x00,0x04,0x0e,0x04,0x00,0x0e,0x00,0x00},
    {0x09,0x0b,0x0d,0x09,0x04,0x04,0x04,0x0c},
    {0x05,0x05,0x05,0x02,0x0c,0x08,0x08,0x08},
    {0x04,0x04,0x04,0x07,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x07,0x04,0x04,0x04,0x04},
    {0x00,0x00,0x00,0x0c,0x04,0x04,0x04,0x04},
    {0x04,0x04,0x04,0x0c,0x00,0x00,0x00,0x00},
    {0x04,0x04,0x04,0x0f,0x04,0x04,0x04,0x04},
    {0x00,0x0e,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x0e,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x0e,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x0e,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x0e,0x00,0x00},
    {0x04,0x04,0x04,0x0c,0x04,0x04,0x04,0x04},
    {0x04,0x04,0x04,0x07,0x04,0x04,0x04,0x04},
    {0x04,0x04,0x04,0x04,0x0f,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x0f,0x04,0x04,0x04},
    {0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04},
    {0x00,0x08,0x04,0x02,0x04,0x08,0x0e,0x00},
    {0x00,0x02,0x04,0x08,0x04,0x02,0x0e,0x00},
    {0x00,0x0f,0x0a,0x0a,0x0a,0x0a,0x00,0x00},
    {0x00,0x08,0x0f,0x04,0x0f,0x02,0x00,0x00},
    {0x0c,0x02,0x07,0x02,0x0e,0x0b,0x02,0x00},
    {0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x02,0x02,0x02,0x02,0x00,0x02,0x00},
    {0x00,0x05,0x05,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x05,0x07,0x05,0x05,0x07,0x05,0x00},
    {0x02,0x02,0x05,0x02,0x04,0x05,0x02,0x02},
    {0x00,0x05,0x04,0x02,0x02,0x01,0x05,0x00},
    {0x02,0x05,0x02,0x05,0x05,0x03,0x06,0x00},
    {0x00,0x02,0x02,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x04,0x02,0x02,0x02,0x02,0x04,0x00},
    {0x00,0x01,0x02,0x02,0x02,0x02,0x01,0x00},
    {0x00,0x05,0x02,0x07,0x02,0x05,0x00,0x00},
    {0x00,0x02,0x02,0x07,0x02,0x02,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x02,0x02,0x01},
    {0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x02,0x02,0x00},
    {0x00,0x04,0x04,0x02,0x02,0x01,0x01,0x00},
    {0x00,0x02,0x05,0x07,0x05,0x05,0x02,0x00},
    {0x00,0x02,0x03,0x02,0x02,0x02,0x07,0x00},
    {0x00,0x02,0x05,0x04,0x02,0x01,0x07,0x00},
    {0x00,0x07,0x04,0x02,0x04,0x05,0x02,0x00},
    {0x00,0x04,0x06,0x05,0x07,0x04,0x04,0x00},
    {0x00,0x07,0x01,0x03,0x04,0x05,0x02,0x00},
    {0x00,0x06,0x01,0x03,0x05,0x05,0x02,0x00},
    {0x00,0x07,0x04,0x04,0x02,0x02,0x02,0x00},
    {0x00,0x02,0x05,0x02,0x05,0x05,0x02,0x00},
    {0x00,0x02,0x05,0x05,0x06,0x04,0x03,0x00},
    {0x00,0x00,0x02,0x00,0x00,0x02,0x00,0x00},
    {0x00,0x00,0x02,0x00,0x00,0x02,0x01,0x00},
    {0x00,0x00,0x04,0x02,0x01,0x02,0x04,0x00},
    {0x00,0x00,0x07,0x00,0x07,0x00,0x00,0x00},
    {0x00,0x00,0x01,0x02,0x04,0x02,0x01,0x00},
    {0x00,0x02,0x05,0x04,0x02,0x00,0x02,0x00},
    {0x00,0x02,0x05,0x05,0x01,0x01,0x06,0x00},
    {0x00,0x02,0x05,0x05,0x07,0x05,0x05,0x00},
    {0x00,0x03,0x05,0x03,0x05,0x05,0x03,0x00},
    {0x00,0x02,0x05,0x01,0x01,0x05,0x02,0x00},
    {0x00,0x03,0x05,0x05,0x05,0x05,0x03,0x00},
    {0x00,0x07,0x01,0x07,0x01,0x01,0x07,0x00},
    {0x00,0x07,0x01,0x07,0x01,0x01,0x01,0x00},
    {0x00,0x02,0x05,0x01,0x05,0x05,0x02,0x00},
    {0x00,0x05,0x05,0x07,0x05,0x05,0x05,0x00},
    {0x00,0x07,0x02,0x02,0x02,0x02,0x07,0x00},
    {0x00,0x04,0x04,0x04,0x04,0x05,0x02,0x00},
    {0x00,0x05,0x05,0x03,0x05,0x05,0x05,0x00},
    {0x00,0x01,0x01,0x01,0x01,0x01,0x07,0x00},
    {0x00,0x05,0x07,0x05,0x05,0x05,0x05,0x00},
    {0x00,0x04,0x05,0x07,0x07,0x05,0x01,0x00},
    {0x00,0x02,0x05,0x05,0x05,0x05,0x02,0x00},
    {0x00,0x03,0x05,0x05,0x03,0x01,0x01,0x00},
    {0x00,0x02,0x05,0x05,0x05,0x03,0x06,0x00},
    {0x00,0x03,0x05,0x05,0x03,0x05,0x05,0x00},
    {0x00,0x02,0x05,0x02,0x04,0x05,0x02,0x00},
    {0x00,0x07,0x02,0x02,0x02,0x02,0x02,0x00},
    {0x00,0x05,0x05,0x05,0x05,0x05,0x07,0x00},
    {0x00,0x05,0x05,0x05,0x05,0x05,0x02,0x00},
    {0x00,0x05,0x05,0x05,0x05,0x07,0x05,0x00},
    {0x00,0x05,0x05,0x02,0x05,0x05,0x05,0x00},
    {0x00,0x05,0x05,0x02,0x02,0x02,0x02,0x00},
    {0x00,0x07,0x04,0x02,0x02,0x01,0x07,0x00},
    {0x00,0x06,0x02,0x02,0x02,0x02,0x06,0x00},
    {0x00,0x01,0x01,0x02,0x02,0x04,0x04,0x00},
    {0x00,0x03,0x02,0x02,0x02,0x02,0x03,0x00},
    {0x00,0x02,0x05,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f},
    {0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x03,0x04,0x06,0x05,0x06,0x00},
    {0x00,0x01,0x01,0x03,0x05,0x05,0x03,0x00},
    {0x00,0x00,0x06,0x01,0x01,0x01,0x06,0x00},
    {0x00,0x04,0x04,0x06,0x05,0x05,0x06,0x00},
    {0x00,0x00,0x02,0x05,0x07,0x01,0x06,0x00},
    {0x00,0x04,0x02,0x07,0x02,0x02,0x02,0x00},
    {0x00,0x00,0x06,0x05,0x05,0x06,0x04,0x03},
    {0x00,0x01,0x01,0x03,0x05,0x05,0x05,0x00},
    {0x00,0x02,0x00,0x03,0x02,0x02,0x07,0x00},
    {0x00,0x04,0x00,0x06,0x04,0x04,0x04,0x03},
    {0x00,0x01,0x01,0x05,0x03,0x05,0x05,0x00},
    {0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x00},
    {0x00,0x00,0x05,0x07,0x05,0x05,0x05,0x00},
    {0x00,0x00,0x03,0x05,0x05,0x05,0x05,0x00},
    {0x00,0x00,0x02,0x05,0x05,0x05,0x02,0x00},
    {0x00,0x00,0x03,0x05,0x05,0x03,0x01,0x01},
    {0x00,0x00,0x06,0x05,0x05,0x06,0x04,0x04},
    {0x00,0x00,0x06,0x01,0x01,0x01,0x01,0x00},
    {0x00,0x00,0x06,0x01,0x02,0x04,0x03,0x00},
    {0x00,0x02,0x02,0x07,0x02,0x02,0x02,0x00},
    {0x00,0x00,0x05,0x05,0x05,0x05,0x07,0x00},
    {0x00,0x00,0x05,0x05,0x05,0x05,0x02,0x00},
    {0x00,0x00,0x05,0x05,0x05,0x07,0x05,0x00},
    {0x00,0x00,0x05,0x05,0x02,0x05,0x05,0x00},
    {0x00,0x00,0x05,0x05,0x05,0x06,0x04,0x03},
    {0x00,0x00,0x07,0x04,0x02,0x01,0x07,0x00},
    {0x04,0x02,0x02,0x01,0x02,0x02,0x04,0x00},
    {0x02,0x02,0x02,0x00,0x02,0x02,0x02,0x00},
    {0x01,0x02,0x02,0x04,0x02,0x02,0x01,0x00},
    {0x00,0x00,0x03,0x06,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};


volatile unsigned short *ioram = (unsigned short *)0x04000000;
volatile unsigned short *vram = (unsigned short *)0x06000000;

void term_init() {
	ioram[0] = 0x0403;
	ioram[20] = 0x0000;
	ioram[21] = 0x0000;
    ioram[22] = 0x0000;
    ioram[23] = 0x0000;
}

inline void setpixel(int x, int y, unsigned short c){
    vram[y*240 + x] = c;
}

void putchr_base(int index, char w, unsigned short fg, unsigned short bg){
    if (w > 128) w = '.';
    int xx = index % 60;
    int yy = index / 60;
    int i, j;
	for (i=0; i<8; i++){
        unsigned char ff = font[w][i];
        for (j=0; j<4; j++) {
            setpixel(xx*4 + j, yy*8 + i, bg);
            if ((ff >> j) & 1) setpixel(xx*4 + j, yy*8 + i, fg);
        }
    }
}

int screen_pos = 0;
int esc = 0;

void inp_draw_status();
void tim_draw_status(int ctr);
void draw_topbar() {
    int i;
    for (i=0; i<240*8; i++) {
        vram[i] = 0x0033;
    }
    putchr_base(0, 'I', 0xff00, 0x0033);
    putchr_base(1, 'N', 0xff00, 0x0033);
    putchr_base(2, 'P', 0xff00, 0x0033);
    putchr_base(3, '=', 0xff00, 0x0033);
    inp_draw_status();
    tim_draw_status(0);
}

void putchr(const char c) {
    if (c == 0x1b) {
        // ansi escape
        esc = 1;
        return;
    }
    if (c == 'h') {
        // todo this is very bad and it will not always work
        if (esc) {
            esc = 0;
            return;
        }
    }
    if (c == '\r') {
        screen_pos /= 60;
        screen_pos *= 60;
        return;
    }
    if (c == '\n') {
        screen_pos += 60;
        screen_pos /= 60;
        screen_pos *= 60;
        return;
    }
    if (esc) return;

    if (screen_pos >= 60*20) {
        // need to scroll
        screen_pos = 60*19;
        int i;
        for (i=0; i<240*8*19; i++) {
            vram[i] = vram[240*8+i];
        }
        // clear bottom row
        for (i=240*8*19; i<240*8*20; i++) {
            vram[i] = 0;
        }
        // redraw top bar
        draw_topbar();
    }
    putchr_base(screen_pos, c, 0xffff, 0x0000);
    screen_pos++;
}

void writestr(const char *str){
    while (*str != 0){
        putchr(*str);
        str++;
    }
}

void writenum(int n) {
    if (n<0) {
        putchr('-');
        n = -n;
    }
    putchr((n / 100000) % 10 + 0x30);
    putchr((n / 10000) % 10 + 0x30);
    putchr((n / 1000) % 10 + 0x30);
    putchr((n / 100) % 10 + 0x30);
    putchr((n / 10) % 10 + 0x30);
    putchr((n / 1) % 10 + 0x30);
}

void cls(){
    int i = 0;
    for (i=0; i<240*160; i++){
        vram[i] = 0;
    }
    screen_pos = 60;
}

void sleep(){
    int i = 0;
    for (i=0; i<1000000; i++) __asm("nop");
}